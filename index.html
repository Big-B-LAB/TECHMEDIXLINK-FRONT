<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>TechMedixLink | Connecting Care with Innovation</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Card hover effect */
        .card-hover {
            transition: all 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        
        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table th {
            background: #f8fafc;
            color: #1e293b;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
        }
        
        .data-table td {
            padding: 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        
        .data-table tbody tr:hover {
            background: #f8fafc;
        }
        
        /* Toast animation */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-animation {
            animation: slideInRight 0.3s ease;
        }
        
        /* Modal animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-overlay {
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .modal-content {
            animation: scaleIn 0.2s ease;
        }
        
        /* Mobile card */
        .mobile-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .mobile-card:hover {
            border-color: #0066cc;
            box-shadow: 0 4px 6px -1px rgb(0 102 204 / 0.1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 antialiased">

    <!-- Header -->
    <header class="bg-gradient-to-r from-[#0066cc] to-[#004d99] sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <button onclick="window.showSection('hero')" class="flex items-center space-x-3 focus:outline-none">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-[#0066cc]">
                        <i class="fas fa-bridge-medical text-xl"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-white font-bold text-lg tracking-tight">TechMedixLink</span>
                        <span class="text-white/80 text-xs hidden sm:block">Connecting Care with Innovation</span>
                    </div>
                </button>

                <!-- Desktop Navigation -->
                <nav class="hidden md:flex items-center space-x-1">
                    <button onclick="window.showSection('dashboard')" class="nav-link px-4 py-2 text-white/90 hover:text-white hover:bg-white/10 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </button>
                    <button onclick="window.showSection('devices')" class="nav-link px-4 py-2 text-white/90 hover:text-white hover:bg-white/10 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="fas fa-stethoscope"></i>
                        <span>Devices</span>
                        <span class="bg-[#00b3b3] text-white text-xs px-2 py-0.5 rounded-full" id="deviceBadge">0</span>
                    </button>
                    <button onclick="window.showSection('providers')" class="nav-link px-4 py-2 text-white/90 hover:text-white hover:bg-white/10 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="fas fa-hospital"></i>
                        <span>Providers</span>
                        <span class="bg-[#00b3b3] text-white text-xs px-2 py-0.5 rounded-full" id="providerBadge">0</span>
                    </button>
                    <button onclick="window.showSection('request')" class="nav-link px-4 py-2 text-white/90 hover:text-white hover:bg-white/10 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="fas fa-file-medical"></i>
                        <span>Request</span>
                    </button>
                    <button onclick="window.showSection('analytics')" class="nav-link px-4 py-2 text-white/90 hover:text-white hover:bg-white/10 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i class="fas fa-chart-bar"></i>
                        <span>Analytics</span>
                    </button>
                </nav>

                <!-- Mobile Menu Button -->
                <button onclick="window.toggleMobileMenu()" class="md:hidden w-10 h-10 flex items-center justify-center text-white hover:bg-white/10 rounded-lg transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden bg-[#004d99] border-t border-white/10">
            <div class="max-w-7xl mx-auto px-4 py-3 space-y-2">
                <button onclick="window.showSection('dashboard'); window.toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-white hover:bg-white/10 rounded-lg transition">
                    <i class="fas fa-chart-line w-5"></i>
                    <span>Dashboard</span>
                </button>
                <button onclick="window.showSection('devices'); window.toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-white hover:bg-white/10 rounded-lg transition">
                    <i class="fas fa-stethoscope w-5"></i>
                    <span>Medical Devices</span>
                    <span class="bg-[#00b3b3] text-white text-xs px-2 py-0.5 rounded-full ml-auto" id="mobileDeviceBadge">0</span>
                </button>
                <button onclick="window.showSection('providers'); window.toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-white hover:bg-white/10 rounded-lg transition">
                    <i class="fas fa-hospital w-5"></i>
                    <span>Healthcare Providers</span>
                    <span class="bg-[#00b3b3] text-white text-xs px-2 py-0.5 rounded-full ml-auto" id="mobileProviderBadge">0</span>
                </button>
                <button onclick="window.showSection('request'); window.toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-white hover:bg-white/10 rounded-lg transition">
                    <i class="fas fa-file-medical w-5"></i>
                    <span>Submit Request</span>
                </button>
                <button onclick="window.showSection('analytics'); window.toggleMobileMenu()" class="w-full flex items-center gap-3 px-4 py-3 text-white hover:bg-white/10 rounded-lg transition">
                    <i class="fas fa-chart-bar w-5"></i>
                    <span>Analytics</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Hero Section -->
        <section id="hero" class="space-y-8">
            <div class="bg-gradient-to-br from-blue-50 to-white rounded-2xl p-8 md:p-12 border border-slate-200">
                <div class="max-w-3xl">
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-800 tracking-tight mb-4">
                        Connecting Care with Innovation
                    </h1>
                    <p class="text-lg text-slate-600 mb-8 leading-relaxed">
                        TechMedixLink bridges Tanzanian healthcare providers with global medical technology. 
                        We don't just supply equipment — we ensure you understand it, train your team, 
                        and support it throughout its lifecycle.
                    </p>
                    
                    <div class="flex flex-wrap gap-4">
                        <button onclick="window.showSection('request')" class="px-6 py-3 bg-[#0066cc] hover:bg-[#004d99] text-white font-medium rounded-lg transition flex items-center gap-2 shadow-md hover:shadow-lg">
                            <i class="fas fa-file-medical"></i>
                            Submit Technology Request
                        </button>
                        <button onclick="window.showSection('dashboard')" class="px-6 py-3 bg-white hover:bg-slate-50 text-slate-700 font-medium rounded-lg transition flex items-center gap-2 border border-slate-200 shadow-sm hover:shadow">
                            <i class="fas fa-chart-line"></i>
                            View Dashboard
                        </button>
                    </div>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-12">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 card-hover">
                        <div class="text-2xl font-bold text-[#0066cc]" id="heroDevices">0</div>
                        <div class="text-sm text-slate-500">Medical Devices</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 card-hover">
                        <div class="text-2xl font-bold text-[#0066cc]" id="heroProviders">0</div>
                        <div class="text-sm text-slate-500">Healthcare Providers</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 card-hover">
                        <div class="text-2xl font-bold text-[#0066cc]" id="heroCertified">0</div>
                        <div class="text-sm text-slate-500">TMDA Certified</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 card-hover">
                        <div class="text-2xl font-bold text-[#0066cc]" id="heroRequests">0</div>
                        <div class="text-sm text-slate-500">Active Requests</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Features -->
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl border border-slate-200 card-hover">
                    <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center text-[#0066cc] mb-4">
                        <i class="fas fa-search text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-slate-800 mb-2">Discover & Evaluate</h3>
                    <p class="text-sm text-slate-500">Browse advanced medical technology with detailed specifications and TMDA certification status.</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 card-hover">
                    <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center text-[#0066cc] mb-4">
                        <i class="fas fa-graduation-cap text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-slate-800 mb-2">Training & Support</h3>
                    <p class="text-sm text-slate-500">Full lifecycle support including staff training, installation, and ongoing maintenance.</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-slate-200 card-hover">
                    <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center text-[#0066cc] mb-4">
                        <i class="fas fa-handshake text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-slate-800 mb-2">Acquisition Assistance</h3>
                    <p class="text-sm text-slate-500">We act as your intermediary for acquiring, financing, and importing medical devices.</p>
                </div>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">Platform Dashboard</h2>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm card-hover">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center text-[#0066cc]">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-slate-800" id="statDevices">0</div>
                            <div class="text-xs text-slate-500">Medical Devices</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm card-hover">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center text-green-600">
                            <i class="fas fa-hospital"></i>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-slate-800" id="statProviders">0</div>
                            <div class="text-xs text-slate-500">Providers</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm card-hover">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-teal-50 rounded-lg flex items-center justify-center text-teal-600">
                            <i class="fas fa-certificate"></i>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-slate-800" id="statCertified">0</div>
                            <div class="text-xs text-slate-500">TMDA Certified</div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm card-hover">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-orange-50 rounded-lg flex items-center justify-center text-orange-600">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-slate-800" id="statLocalSupport">0</div>
                            <div class="text-xs text-slate-500">Local Support</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Devices -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-[#0066cc]">
                                <i class="fas fa-history text-sm"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-slate-800">Recent Medical Devices</h3>
                                <p class="text-xs text-slate-500">Latest additions to the catalog</p>
                            </div>
                        </div>
                        <button onclick="window.loadDevices()" class="px-3 py-1.5 text-sm bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="p-6" id="recentDevices">
                    <div class="flex flex-col items-center justify-center py-8 text-slate-400">
                        <div class="w-12 h-12 border-4 border-slate-200 border-t-[#0066cc] rounded-full animate-spin mb-4"></div>
                        <p class="text-sm">Loading recent devices...</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-[#0066cc]">
                            <i class="fas fa-bolt text-sm"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-slate-800">Quick Actions</h3>
                            <p class="text-xs text-slate-500">Common platform operations</p>
                        </div>
                    </div>
                </div>
                <div class="p-6 flex flex-wrap gap-3">
                    <button onclick="window.showSection('request')" class="px-4 py-2 bg-[#0066cc] text-white text-sm font-medium rounded-lg hover:bg-[#004d99] transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Add New Request
                    </button>
                    <button onclick="window.showModal('device')" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 text-sm font-medium rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Add New Device
                    </button>
                    <button onclick="window.showModal('provider')" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 text-sm font-medium rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Add New Provider
                    </button>
                    <button onclick="window.loadAllData()" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 text-sm font-medium rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        Refresh All Data
                    </button>
                </div>
            </div>
        </section>

        <!-- Medical Devices Section -->
        <section id="devices" class="hidden space-y-6">
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-[#0066cc]">
                                <i class="fas fa-stethoscope text-sm"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-slate-800">Medical Devices Catalog</h3>
                                <p class="text-xs text-slate-500">Advanced medical technology for Tanzanian healthcare</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.showSection('request')" class="px-3 py-1.5 bg-[#0066cc] text-white text-sm rounded-lg hover:bg-[#004d99] transition flex items-center gap-2">
                                <i class="fas fa-file-medical"></i>
                                Request
                            </button>
                            <button onclick="window.showModal('device')" class="px-3 py-1.5 bg-white border border-slate-200 text-slate-600 text-sm rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                                Add Device
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="p-6 border-b border-slate-200 bg-white">
                    <div class="flex flex-wrap gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs text-slate-500 mb-1">Filter by</label>
                            <select id="deviceFilter" onchange="window.filterDevices()" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                <option value="all">All Devices</option>
                                <option value="certified">TMDA Certified Only</option>
                                <option value="local">Local Support Available</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs text-slate-500 mb-1">Sort by</label>
                            <select id="deviceSort" onchange="window.sortDevices()" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                <option value="name">Device Name</option>
                                <option value="price-low">Price: Low to High</option>
                                <option value="price-high">Price: High to Low</option>
                                <option value="certified">Certification Status</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="window.resetFilters()" class="px-4 py-2 border border-slate-200 text-slate-600 text-sm rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                                <i class="fas fa-redo-alt"></i>
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Devices List -->
                <div class="p-6" id="devicesList">
                    <div class="flex flex-col items-center justify-center py-12 text-slate-400">
                        <div class="w-12 h-12 border-4 border-slate-200 border-t-[#0066cc] rounded-full animate-spin mb-4"></div>
                        <p class="text-sm">Loading medical devices...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Healthcare Providers Section -->
        <section id="providers" class="hidden space-y-6">
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-[#0066cc]">
                                <i class="fas fa-hospital text-sm"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-slate-800">Healthcare Providers Network</h3>
                                <p class="text-xs text-slate-500">Tanzanian healthcare facilities on the platform</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.exportProviders()" class="px-3 py-1.5 bg-white border border-slate-200 text-slate-600 text-sm rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                                <i class="fas fa-download"></i>
                                Export
                            </button>
                            <button onclick="window.showModal('provider')" class="px-3 py-1.5 bg-[#0066cc] text-white text-sm rounded-lg hover:bg-[#004d99] transition flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                                Add Provider
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="p-6 border-b border-slate-200 bg-white">
                    <div class="flex flex-wrap gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs text-slate-500 mb-1">Region</label>
                            <select id="regionFilter" onchange="window.filterProviders()" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                <option value="all">All Regions</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs text-slate-500 mb-1">Facility Type</label>
                            <select id="facilityFilter" onchange="window.filterProviders()" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                <option value="all">All Types</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="window.resetProviderFilters()" class="px-4 py-2 border border-slate-200 text-slate-600 text-sm rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                                <i class="fas fa-redo-alt"></i>
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Providers List -->
                <div class="p-6" id="providersList">
                    <div class="flex flex-col items-center justify-center py-12 text-slate-400">
                        <div class="w-12 h-12 border-4 border-slate-200 border-t-[#0066cc] rounded-full animate-spin mb-4"></div>
                        <p class="text-sm">Loading healthcare providers...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Request Form Section -->
        <section id="request" class="hidden">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-[#0066cc] mx-auto mb-4">
                            <i class="fas fa-file-medical text-2xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Medical Technology Request</h2>
                        <p class="text-sm text-slate-500">Submit your request for medical equipment or technology consultation</p>
                    </div>

                    <div id="requestMessage" class="hidden mb-6 p-4 rounded-lg flex items-center gap-3"></div>

                    <form id="requestForm" onsubmit="window.submitRequest(event)">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-hospital text-[#0066cc] mr-2"></i>
                                    Healthcare Facility *
                                </label>
                                <select id="providerSelect" required class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                    <option value="">Select your hospital or clinic</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-stethoscope text-[#0066cc] mr-2"></i>
                                    Medical Technology Requested *
                                </label>
                                <select id="deviceSelect" required class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                    <option value="">Select medical device or technology</option>
                                </select>
                                <div id="deviceDetails" class="mt-3"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-boxes text-[#0066cc] mr-2"></i>
                                    Quantity Needed *
                                </label>
                                <input type="number" id="quantity" min="1" max="100" value="1" required class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-clock text-[#0066cc] mr-2"></i>
                                    Urgency Level
                                </label>
                                <select id="urgency" class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                    <option value="normal">Normal Priority</option>
                                    <option value="high">High Priority</option>
                                    <option value="urgent">Urgent - Critical Need</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    <i class="fas fa-notes-medical text-[#0066cc] mr-2"></i>
                                    Additional Requirements
                                </label>
                                <textarea id="notes" rows="4" placeholder="Please provide specific requirements, installation needs, training requirements, or any other details..." class="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]"></textarea>
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-slate-600">
                                    <i class="fas fa-info-circle text-[#0066cc] mr-2"></i>
                                    After submission, our team will contact you within 24 hours to discuss the next steps.
                                </p>
                            </div>

                            <div class="flex gap-4">
                                <button type="submit" class="flex-1 px-6 py-3 bg-[#0066cc] text-white font-medium rounded-lg hover:bg-[#004d99] transition flex items-center justify-center gap-2">
                                    <i class="fas fa-paper-plane"></i>
                                    Submit Request
                                </button>
                                <button type="button" onclick="window.resetForm()" class="px-6 py-3 bg-white border border-slate-200 text-slate-600 font-medium rounded-lg hover:bg-slate-50 transition flex items-center justify-center gap-2">
                                    <i class="fas fa-redo-alt"></i>
                                    Reset
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="hidden space-y-6">
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-200 bg-slate-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-[#0066cc]">
                                <i class="fas fa-chart-bar text-sm"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-slate-800">Platform Analytics</h3>
                                <p class="text-xs text-slate-500">Data insights and platform performance metrics</p>
                            </div>
                        </div>
                        <button onclick="window.refreshAnalytics()" class="px-3 py-1.5 bg-white border border-slate-200 text-slate-600 text-sm rounded-lg hover:bg-slate-50 transition flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-slate-800" id="analyticsDevices">0</div>
                            <div class="text-xs text-slate-500">Total Devices</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-slate-800" id="analyticsProviders">0</div>
                            <div class="text-xs text-slate-500">Active Providers</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-slate-800" id="analyticsCertified">0%</div>
                            <div class="text-xs text-slate-500">Certification Rate</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-slate-800" id="analyticsRegions">0</div>
                            <div class="text-xs text-slate-500">Regions Covered</div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold text-slate-700 mb-4">Regional Distribution</h4>
                        <div id="regionChart" class="bg-slate-50 p-4 rounded-lg min-h-[200px] flex items-center justify-center">
                            <div class="flex flex-col items-center text-slate-400">
                                <div class="w-10 h-10 border-4 border-slate-200 border-t-[#0066cc] rounded-full animate-spin mb-3"></div>
                                <p class="text-sm">Loading regional data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-white mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-bridge-medical text-white"></i>
                        </div>
                        <span class="font-bold text-lg">TechMedixLink</span>
                    </div>
                    <p class="text-sm text-slate-400 leading-relaxed">
                        Connecting Tanzanian healthcare providers with global medical innovation. Full lifecycle support from evaluation to maintenance.
                    </p>
                </div>
                
                <div>
                    <h5 class="font-semibold text-sm uppercase tracking-wider text-slate-400 mb-4">Platform</h5>
                    <ul class="space-y-2 text-sm">
                        <li><button onclick="window.showSection('dashboard')" class="text-slate-300 hover:text-white transition">Dashboard</button></li>
                        <li><button onclick="window.showSection('devices')" class="text-slate-300 hover:text-white transition">Medical Devices</button></li>
                        <li><button onclick="window.showSection('providers')" class="text-slate-300 hover:text-white transition">Healthcare Providers</button></li>
                        <li><button onclick="window.showSection('request')" class="text-slate-300 hover:text-white transition">Submit Request</button></li>
                    </ul>
                </div>
                
                <div>
                    <h5 class="font-semibold text-sm uppercase tracking-wider text-slate-400 mb-4">Technology</h5>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center gap-2 text-slate-300"><i class="fas fa-database text-teal-400 w-4"></i> Database: Supabase</li>
                        <li class="flex items-center gap-2 text-slate-300"><i class="fas fa-code text-teal-400 w-4"></i> API Status: <span id="footerStatus" class="text-yellow-400">Checking...</span></li>
                        <li class="flex items-center gap-2 text-slate-300"><i class="fas fa-shield-alt text-teal-400 w-4"></i> Data Security: HIPAA Compliant</li>
                    </ul>
                </div>
                
                <div>
                    <h5 class="font-semibold text-sm uppercase tracking-wider text-slate-400 mb-4">Contact</h5>
                    <ul class="space-y-2 text-sm">
                        <li><a href="mailto:info@techmedixlink.tz" class="text-slate-300 hover:text-white transition flex items-center gap-2"><i class="fas fa-envelope text-teal-400 w-4"></i> info@techmedixlink.tz</a></li>
                        <li><a href="tel:+255222000000" class="text-slate-300 hover:text-white transition flex items-center gap-2"><i class="fas fa-phone text-teal-400 w-4"></i> +255 22 200 0000</a></li>
                        <li class="flex items-center gap-2 text-slate-300"><i class="fas fa-map-marker-alt text-teal-400 w-4"></i> Dar es Salaam, Tanzania</li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-slate-700 mt-12 pt-8 text-center text-sm text-slate-400">
                <p>© 2024 TechMedixLink - Connecting Care with Innovation</p>
                <p class="mt-2">Empowering Tanzanian healthcare through technology, training, and full lifecycle support.</p>
            </div>
        </div>
    </footer>

    <!-- Device Modal -->
    <div id="deviceModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 modal-overlay">
        <div class="bg-white rounded-xl max-w-md w-full mx-4 modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="deviceModalTitle" class="text-lg font-semibold text-slate-800">Add New Medical Device</h3>
                    <button onclick="window.closeModal('device')" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="deviceForm" onsubmit="window.saveDevice(event)">
                    <input type="hidden" id="deviceId">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Device Name *</label>
                            <input type="text" id="deviceName" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Manufacturer *</label>
                            <input type="text" id="deviceManufacturer" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Device Type *</label>
                            <select id="deviceType" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                <option value="">Select type</option>
                                <option value="Diagnostic">Diagnostic Equipment</option>
                                <option value="Therapeutic">Therapeutic Equipment</option>
                                <option value="Monitoring">Patient Monitoring</option>
                                <option value="Surgical">Surgical Equipment</option>
                                <option value="Laboratory">Laboratory Equipment</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Price (USD) *</label>
                            <input type="number" id="devicePrice" min="0" step="0.01" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                            <textarea id="deviceDescription" rows="3" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]"></textarea>
                        </div>
                        
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 text-sm text-slate-600">
                                <input type="checkbox" id="deviceCertified" class="rounded border-slate-300 text-[#0066cc] focus:ring-[#0066cc]">
                                <span>TMDA Certified</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm text-slate-600">
                                <input type="checkbox" id="deviceLocalSupport" class="rounded border-slate-300 text-[#0066cc] focus:ring-[#0066cc]">
                                <span>Local Support Available</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6 pt-4 border-t border-slate-200">
                        <button type="submit" class="flex-1 px-4 py-2 bg-[#0066cc] text-white text-sm font-medium rounded-lg hover:bg-[#004d99] transition">
                            Save Device
                        </button>
                        <button type="button" onclick="window.closeModal('device')" class="flex-1 px-4 py-2 bg-white border border-slate-200 text-slate-600 text-sm font-medium rounded-lg hover:bg-slate-50 transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Provider Modal -->
    <div id="providerModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 modal-overlay">
        <div class="bg-white rounded-xl max-w-md w-full mx-4 modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="providerModalTitle" class="text-lg font-semibold text-slate-800">Add New Healthcare Provider</h3>
                    <button onclick="window.closeModal('provider')" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="providerForm" onsubmit="window.saveProvider(event)">
                    <input type="hidden" id="providerId">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Facility Name *</label>
                            <input type="text" id="providerName" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Facility Type *</label>
                            <select id="providerType" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                <option value="">Select type</option>
                                <option value="Hospital">Hospital</option>
                                <option value="Clinic">Clinic</option>
                                <option value="Referral Hospital">Referral Hospital</option>
                                <option value="Private Hospital">Private Hospital</option>
                                <option value="Health Center">Health Center</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Region *</label>
                            <select id="providerRegion" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                                <option value="">Select region</option>
                                <option value="Dar es Salaam">Dar es Salaam</option>
                                <option value="Kilimanjaro">Kilimanjaro</option>
                                <option value="Mbeya">Mbeya</option>
                                <option value="Mwanza">Mwanza</option>
                                <option value="Tanga">Tanga</option>
                                <option value="Morogoro">Morogoro</option>
                                <option value="Pwani">Pwani</option>
                                <option value="Arusha">Arusha</option>
                                <option value="Dodoma">Dodoma</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Location *</label>
                            <input type="text" id="providerLocation" required class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Contact Person</label>
                            <input type="text" id="providerContact" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Phone Number</label>
                            <input type="tel" id="providerPhone" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-[#0066cc] focus:ring-1 focus:ring-[#0066cc]">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6 pt-4 border-t border-slate-200">
                        <button type="submit" class="flex-1 px-4 py-2 bg-[#0066cc] text-white text-sm font-medium rounded-lg hover:bg-[#004d99] transition">
                            Save Provider
                        </button>
                        <button type="button" onclick="window.closeModal('provider')" class="flex-1 px-4 py-2 bg-white border border-slate-200 text-slate-600 text-sm font-medium rounded-lg hover:bg-slate-50 transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 modal-overlay">
        <div class="bg-white rounded-xl max-w-md w-full mx-4 modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">Confirm Deletion</h3>
                    <button onclick="window.closeModal('delete')" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <p id="deleteMessage" class="text-slate-600 mb-6">Are you sure you want to delete this item?</p>
                
                <div class="flex gap-3">
                    <button onclick="window.confirmDelete()" class="flex-1 px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition">
                        Delete
                    </button>
                    <button onclick="window.closeModal('delete')" class="flex-1 px-4 py-2 bg-white border border-slate-200 text-slate-600 text-sm font-medium rounded-lg hover:bg-slate-50 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-20 right-4 z-50"></div>

    <!-- Main JavaScript -->
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://sseoocgkfyncrncgtkpz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzZW9vY2drZnluY3JuY2d0a3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjU5NDIsImV4cCI6MjA4NDAwMTk0Mn0.CraMHSx3rRkZAgLseOjVZBGepDeCb5xz4XcMq84stU4';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('✅ Supabase initialized');

        // ====== STATE MANAGEMENT ======
        let allDevices = [];
        let allProviders = [];
        let currentDeleteId = null;
        let currentDeleteType = null;

        // ====== INITIALIZATION ======
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 TechMedixLink initializing...');
            showSection('hero');
            loadAllData();
            checkSupabaseConnection();
        });

        // ====== UI FUNCTIONS ======
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('section[id]').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            const section = document.getElementById(sectionId);
            if (section) section.classList.remove('hidden');
            
            // Load data for section if needed
            if (sectionId === 'devices') loadDevices();
            if (sectionId === 'providers') loadProviders();
            if (sectionId === 'request') loadFormData();
            if (sectionId === 'analytics') loadAnalytics();
            
            // Close mobile menu if open
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) mobileMenu.classList.add('hidden');
        }

        // ====== SUPABASE CONNECTION ======
        async function checkSupabaseConnection() {
            const statusEl = document.getElementById('footerStatus');
            if (!statusEl) return;
            
            try {
                const { data, error } = await supabase.from('devices').select('count', { count: 'exact', head: true });
                if (error) throw error;
                statusEl.textContent = 'Connected';
                statusEl.className = 'text-green-400';
                console.log('✅ Supabase connected');
            } catch (error) {
                console.error('❌ Supabase connection error:', error);
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'text-red-400';
            }
        }

        // ====== NOTIFICATIONS ======
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-50 border-green-200 text-green-700' :
                           type === 'error' ? 'bg-red-50 border-red-200 text-red-700' :
                           'bg-blue-50 border-blue-200 text-blue-700';
            
            const icon = type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        'fa-info-circle';
            
            toast.className = `toast-animation ${bgColor} border rounded-lg px-4 py-3 mb-2 flex items-center gap-3 shadow-lg min-w-[300px]`;
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span class="text-sm flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }

        // ====== LOAD ALL DATA ======
        async function loadAllData() {
            try {
                await Promise.all([loadDevices(), loadProviders()]);
                updateDashboardStats();
                updateNavBadges();
                showToast('Data refreshed successfully');
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Failed to load data', 'error');
            }
        }

        function updateNavBadges() {
            const deviceBadge = document.getElementById('deviceBadge');
            const providerBadge = document.getElementById('providerBadge');
            const mobileDeviceBadge = document.getElementById('mobileDeviceBadge');
            const mobileProviderBadge = document.getElementById('mobileProviderBadge');
            
            if (deviceBadge) deviceBadge.textContent = allDevices.length;
            if (providerBadge) providerBadge.textContent = allProviders.length;
            if (mobileDeviceBadge) mobileDeviceBadge.textContent = allDevices.length;
            if (mobileProviderBadge) mobileProviderBadge.textContent = allProviders.length;
        }

        // ====== DEVICE FUNCTIONS ======
        async function loadDevices() {
            const container = document.getElementById('devicesList');
            const recentContainer = document.getElementById('recentDevices');
            
            try {
                const { data: devices, error } = await supabase
                    .from('devices')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allDevices = devices || [];
                displayDevices(allDevices);
                updateDeviceSelect(allDevices);
                updateDashboardStats();
                updateRecentDevices(allDevices.slice(0, 3));
                
            } catch (error) {
                console.error('Error loading devices:', error);
                const errorHtml = `<div class="flex items-center justify-center p-8 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Error loading devices: ${error.message}</div>`;
                if (container) container.innerHTML = errorHtml;
                if (recentContainer) recentContainer.innerHTML = errorHtml;
            }
        }

        async function saveDevice(event) {
            event.preventDefault();
            
            const deviceData = {
                name: document.getElementById('deviceName').value,
                manufacturer: document.getElementById('deviceManufacturer').value,
                device_type: document.getElementById('deviceType').value,
                price_usd: parseFloat(document.getElementById('devicePrice').value) || 0,
                description: document.getElementById('deviceDescription').value || null,
                tz_certified: document.getElementById('deviceCertified').checked,
                local_support: document.getElementById('deviceLocalSupport').checked,
                created_at: new Date().toISOString()
            };

            const deviceId = document.getElementById('deviceId').value;
            const isEdit = deviceId && deviceId !== '';

            try {
                if (isEdit) {
                    const { error } = await supabase
                        .from('devices')
                        .update(deviceData)
                        .eq('id', deviceId);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('devices')
                        .insert([deviceData]);
                    
                    if (error) throw error;
                }

                closeModal('device');
                showToast(isEdit ? 'Device updated successfully' : 'Device added successfully');
                loadDevices();
                
            } catch (error) {
                console.error('Error saving device:', error);
                showToast('Error saving device: ' + error.message, 'error');
            }
        }

        async function deleteDevice(deviceId) {
            currentDeleteId = deviceId;
            currentDeleteType = 'device';
            const deleteMsg = document.getElementById('deleteMessage');
            if (deleteMsg) deleteMsg.textContent = 'Are you sure you want to delete this device?';
            showModal('delete');
        }

        function editDevice(deviceId) {
            const device = allDevices.find(d => d.id === deviceId);
            if (!device) return;

            document.getElementById('deviceModalTitle').textContent = 'Edit Medical Device';
            document.getElementById('deviceId').value = device.id;
            document.getElementById('deviceName').value = device.name || '';
            document.getElementById('deviceManufacturer').value = device.manufacturer || '';
            document.getElementById('deviceType').value = device.device_type || '';
            document.getElementById('devicePrice').value = device.price_usd || '';
            document.getElementById('deviceDescription').value = device.description || '';
            document.getElementById('deviceCertified').checked = device.tz_certified || false;
            document.getElementById('deviceLocalSupport').checked = device.local_support || false;

            showModal('device');
        }

        // ====== PROVIDER FUNCTIONS ======
        async function loadProviders() {
            const container = document.getElementById('providersList');
            if (!container) return;
            
            try {
                const { data: providers, error } = await supabase
                    .from('providers')
                    .select('*')
                    .order('name', { ascending: true });

                if (error) throw error;

                allProviders = providers || [];
                displayProviders(allProviders);
                updateProviderSelect(allProviders);
                updateRegionFilters(allProviders);
                updateFacilityFilters(allProviders);
                updateDashboardStats();
                
            } catch (error) {
                console.error('Error loading providers:', error);
                container.innerHTML = `<div class="flex items-center justify-center p-8 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Error loading providers: ${error.message}</div>`;
            }
        }

        async function saveProvider(event) {
            event.preventDefault();
            
            const providerData = {
                name: document.getElementById('providerName').value,
                facility_type: document.getElementById('providerType').value,
                region: document.getElementById('providerRegion').value,
                location: document.getElementById('providerLocation').value,
                contact_person: document.getElementById('providerContact').value || null,
                phone: document.getElementById('providerPhone').value || null,
                created_at: new Date().toISOString()
            };

            const providerId = document.getElementById('providerId').value;
            const isEdit = providerId && providerId !== '';

            try {
                if (isEdit) {
                    const { error } = await supabase
                        .from('providers')
                        .update(providerData)
                        .eq('id', providerId);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('providers')
                        .insert([providerData]);
                    
                    if (error) throw error;
                }

                closeModal('provider');
                showToast(isEdit ? 'Provider updated successfully' : 'Provider added successfully');
                loadProviders();
                
            } catch (error) {
                console.error('Error saving provider:', error);
                showToast('Error saving provider: ' + error.message, 'error');
            }
        }

        async function deleteProvider(providerId) {
            currentDeleteId = providerId;
            currentDeleteType = 'provider';
            const deleteMsg = document.getElementById('deleteMessage');
            if (deleteMsg) deleteMsg.textContent = 'Are you sure you want to delete this provider?';
            showModal('delete');
        }

        function editProvider(providerId) {
            const provider = allProviders.find(p => p.id === providerId);
            if (!provider) return;

            document.getElementById('providerModalTitle').textContent = 'Edit Healthcare Provider';
            document.getElementById('providerId').value = provider.id;
            document.getElementById('providerName').value = provider.name || '';
            document.getElementById('providerType').value = provider.facility_type || '';
            document.getElementById('providerRegion').value = provider.region || '';
            document.getElementById('providerLocation').value = provider.location || '';
            document.getElementById('providerContact').value = provider.contact_person || '';
            document.getElementById('providerPhone').value = provider.phone || '';

            showModal('provider');
        }

        async function confirmDelete() {
            if (!currentDeleteId || !currentDeleteType) return;

            try {
                const { error } = await supabase
                    .from(currentDeleteType === 'device' ? 'devices' : 'providers')
                    .delete()
                    .eq('id', currentDeleteId);

                if (error) throw error;

                showToast(`${currentDeleteType === 'device' ? 'Device' : 'Provider'} deleted successfully`);
                closeModal('delete');
                
                if (currentDeleteType === 'device') {
                    loadDevices();
                } else {
                    loadProviders();
                }
                
            } catch (error) {
                console.error('Error deleting:', error);
                showToast('Error deleting item: ' + error.message, 'error');
            }
        }

        // ====== DISPLAY FUNCTIONS ======
        function displayDevices(devices) {
            const container = document.getElementById('devicesList');
            if (!container) return;
            
            if (!devices || devices.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center p-8 text-slate-400"><i class="fas fa-info-circle mr-2"></i>No medical devices found. Add your first device!</div>';
                return;
            }
            
            if (window.innerWidth <= 768) {
                displayDevicesMobile(devices);
            } else {
                displayDevicesDesktop(devices);
            }
        }

        function displayDevicesDesktop(devices) {
            const container = document.getElementById('devicesList');
            if (!container) return;
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Manufacturer</th>
                                <th>Type</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            devices.forEach(device => {
                html += `
                    <tr>
                        <td>
                            <div class="font-medium text-slate-800">${escapeHtml(device.name)}</div>
                            <div class="text-xs text-slate-400 mt-0.5">${device.description ? escapeHtml(device.description.substring(0, 60)) + '...' : ''}</div>
                        </td>
                        <td class="text-slate-600">${escapeHtml(device.manufacturer)}</td>
                        <td><span class="px-2 py-1 bg-blue-50 text-[#0066cc] text-xs rounded-full">${escapeHtml(device.device_type)}</span></td>
                        <td class="font-medium">$${device.price_usd?.toLocaleString() || '0'}</td>
                        <td>
                            <div class="space-y-1">
                                ${device.tz_certified ? 
                                    '<span class="inline-flex items-center px-2 py-0.5 bg-green-50 text-green-600 text-xs rounded-full"><i class="fas fa-check mr-1"></i>Certified</span>' : 
                                    '<span class="inline-flex items-center px-2 py-0.5 bg-yellow-50 text-yellow-600 text-xs rounded-full"><i class="fas fa-clock mr-1"></i>Pending</span>'}
                                ${device.local_support ? 
                                    '<span class="inline-flex items-center px-2 py-0.5 bg-green-50 text-green-600 text-xs rounded-full ml-1"><i class="fas fa-check mr-1"></i>Local Support</span>' : 
                                    '<span class="inline-flex items-center px-2 py-0.5 bg-slate-50 text-slate-500 text-xs rounded-full ml-1"><i class="fas fa-times mr-1"></i>No Support</span>'}
                            </div>
                        </td>
                        <td>
                            <div class="flex items-center gap-1">
                                <button onclick="editDevice('${device.id}')" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-[#0066cc] hover:bg-slate-100 rounded-lg transition" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteDevice('${device.id}')" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-slate-100 rounded-lg transition" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button onclick="requestDevice('${device.id}')" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-[#0066cc] hover:bg-slate-100 rounded-lg transition" title="Request">
                                    <i class="fas fa-file-medical"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function displayDevicesMobile(devices) {
            const container = document.getElementById('devicesList');
            if (!container) return;
            
            let html = '';
            
            devices.forEach(device => {
                html += `
                    <div class="mobile-card">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-semibold text-slate-800">${escapeHtml(device.name)}</div>
                                <div class="text-xs text-slate-400">${escapeHtml(device.manufacturer)}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-[#0066cc]">$${device.price_usd?.toLocaleString() || '0'}</div>
                                <span class="text-xs px-2 py-0.5 bg-blue-50 text-[#0066cc] rounded-full">${escapeHtml(device.device_type)}</span>
                            </div>
                        </div>
                        
                        <div class="text-xs text-slate-500 mb-3">
                            ${device.description ? escapeHtml(device.description.substring(0, 100)) + '...' : ''}
                        </div>
                        
                        <div class="flex gap-1 mb-3 flex-wrap">
                            ${device.tz_certified ? 
                                '<span class="px-2 py-0.5 bg-green-50 text-green-600 text-xs rounded-full"><i class="fas fa-check mr-1"></i>Certified</span>' : 
                                '<span class="px-2 py-0.5 bg-yellow-50 text-yellow-600 text-xs rounded-full"><i class="fas fa-clock mr-1"></i>Pending</span>'}
                            ${device.local_support ? 
                                '<span class="px-2 py-0.5 bg-green-50 text-green-600 text-xs rounded-full"><i class="fas fa-check mr-1"></i>Local Support</span>' : 
                                '<span class="px-2 py-0.5 bg-slate-50 text-slate-500 text-xs rounded-full"><i class="fas fa-times mr-1"></i>No Support</span>'}
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="editDevice('${device.id}')" class="flex-1 px-3 py-1.5 bg-white border border-slate-200 text-slate-600 text-xs rounded-lg hover:bg-slate-50 transition flex items-center justify-center gap-1">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                            <button onclick="deleteDevice('${device.id}')" class="flex-1 px-3 py-1.5 bg-white border border-slate-200 text-red-500 text-xs rounded-lg hover:bg-slate-50 transition flex items-center justify-center gap-1">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                            <button onclick="requestDevice('${device.id}')" class="flex-1 px-3 py-1.5 bg-[#0066cc] text-white text-xs rounded-lg hover:bg-[#004d99] transition flex items-center justify-center gap-1">
                                <i class="fas fa-file-medical"></i>
                                Request
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function displayProviders(providers) {
            const container = document.getElementById('providersList');
            if (!container) return;
            
            if (!providers || providers.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center p-8 text-slate-400"><i class="fas fa-info-circle mr-2"></i>No healthcare providers found. Add your first provider!</div>';
                return;
            }
            
            if (window.innerWidth <= 768) {
                displayProvidersMobile(providers);
            } else {
                displayProvidersDesktop(providers);
            }
        }

        function displayProvidersDesktop(providers) {
            const container = document.getElementById('providersList');
            if (!container) return;
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Healthcare Facility</th>
                                <th>Location</th>
                                <th>Region</th>
                                <th>Type</th>
                                <th>Contact</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            providers.forEach(provider => {
                html += `
                    <tr>
                        <td>
                            <div class="font-medium text-slate-800">${escapeHtml(provider.name)}</div>
                            <div class="text-xs text-slate-400 mt-0.5">${provider.contact_person || ''}</div>
                        </td>
                        <td class="text-slate-600">${escapeHtml(provider.location)}</td>
                        <td><span class="px-2 py-1 bg-blue-50 text-[#0066cc] text-xs rounded-full">${escapeHtml(provider.region)}</span></td>
                        <td class="text-slate-600">${escapeHtml(provider.facility_type)}</td>
                        <td>
                            ${provider.phone ? 
                                `<a href="tel:${provider.phone}" class="text-[#0066cc] hover:underline text-sm">${provider.phone}</a>` : 
                                '<span class="text-slate-400">—</span>'}
                        </td>
                        <td>
                            <div class="flex items-center gap-1">
                                <button onclick="editProvider('${provider.id}')" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-[#0066cc] hover:bg-slate-100 rounded-lg transition" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProvider('${provider.id}')" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 hover:bg-slate-100 rounded-lg transition" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ${provider.phone ? 
                                    `<a href="tel:${provider.phone}" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-[#0066cc] hover:bg-slate-100 rounded-lg transition" title="Call">
                                        <i class="fas fa-phone"></i>
                                    </a>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function displayProvidersMobile(providers) {
            const container = document.getElementById('providersList');
            if (!container) return;
            
            let html = '';
            
            providers.forEach(provider => {
                html += `
                    <div class="mobile-card">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-semibold text-slate-800">${escapeHtml(provider.name)}</div>
                                <div class="text-xs text-slate-400">${provider.contact_person || ''}</div>
                            </div>
                            <span class="px-2 py-0.5 bg-blue-50 text-[#0066cc] text-xs rounded-full">${escapeHtml(provider.facility_type)}</span>
                        </div>
                        
                        <div class="space-y-1 mb-3 text-sm">
                            <div class="flex items-center text-slate-600">
                                <i class="fas fa-map-marker-alt text-[#0066cc] w-4 mr-2"></i>
                                ${escapeHtml(provider.location)}
                            </div>
                            <div class="flex items-center text-slate-600">
                                <i class="fas fa-globe-africa text-teal-500 w-4 mr-2"></i>
                                <span class="px-2 py-0.5 bg-blue-50 text-[#0066cc] text-xs rounded-full">${escapeHtml(provider.region)}</span>
                            </div>
                            ${provider.phone ? `
                                <div class="flex items-center text-slate-600">
                                    <i class="fas fa-phone text-green-500 w-4 mr-2"></i>
                                    <a href="tel:${provider.phone}" class="text-[#0066cc]">${provider.phone}</a>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="editProvider('${provider.id}')" class="flex-1 px-3 py-1.5 bg-white border border-slate-200 text-slate-600 text-xs rounded-lg hover:bg-slate-50 transition flex items-center justify-center gap-1">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                            <button onclick="deleteProvider('${provider.id}')" class="flex-1 px-3 py-1.5 bg-white border border-slate-200 text-red-500 text-xs rounded-lg hover:bg-slate-50 transition flex items-center justify-center gap-1">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                            ${provider.phone ? `
                                <a href="tel:${provider.phone}" class="flex-1 px-3 py-1.5 bg-[#0066cc] text-white text-xs rounded-lg hover:bg-[#004d99] transition flex items-center justify-center gap-1">
                                    <i class="fas fa-phone"></i>
                                    Call
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ====== REQUEST FUNCTIONS ======
        async function submitRequest(event) {
            event.preventDefault();
            
            const messageDiv = document.getElementById('requestMessage');
            const form = document.getElementById('requestForm');
            if (!messageDiv || !form) return;
            
            const requestData = {
                provider_id: document.getElementById('providerSelect').value,
                device_id: document.getElementById('deviceSelect').value,
                quantity: parseInt(document.getElementById('quantity').value) || 1,
                urgency: document.getElementById('urgency').value,
                notes: document.getElementById('notes').value || null,
                status: 'submitted',
                created_at: new Date().toISOString()
            };
            
            // Show loading
            messageDiv.className = 'mb-6 p-4 rounded-lg flex items-center gap-3 bg-blue-50 border border-blue-200 text-blue-700';
            messageDiv.innerHTML = '<div class="w-5 h-5 border-2 border-blue-200 border-t-blue-700 rounded-full animate-spin"></div><span>Submitting your request...</span>';
            messageDiv.classList.remove('hidden');
            
            try {
                const { error } = await supabase
                    .from('requests')
                    .insert([requestData]);

                if (error) throw error;

                messageDiv.className = 'mb-6 p-4 rounded-lg flex items-center gap-3 bg-green-50 border border-green-200 text-green-700';
                messageDiv.innerHTML = '<i class="fas fa-check-circle"></i><span>Request submitted successfully! Our team will contact you shortly.</span>';
                
                form.reset();
                const deviceDetails = document.getElementById('deviceDetails');
                if (deviceDetails) deviceDetails.innerHTML = '';
                
                showToast('Request submitted successfully!');
                
                // Update request count
                updateRequestCount();
                
            } catch (error) {
                console.error('Error submitting request:', error);
                messageDiv.className = 'mb-6 p-4 rounded-lg flex items-center gap-3 bg-red-50 border border-red-200 text-red-700';
                messageDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Error: ' + error.message + '</span>';
            }
        }

        async function updateRequestCount() {
            try {
                const { count, error } = await supabase
                    .from('requests')
                    .select('*', { count: 'exact', head: true });

                if (!error) {
                    const heroRequests = document.getElementById('heroRequests');
                    if (heroRequests) heroRequests.textContent = count || 0;
                }
            } catch (error) {
                console.error('Error updating request count:', error);
            }
        }

        // ====== FORM HELPERS ======
        function updateDeviceSelect(devices) {
            const select = document.getElementById('deviceSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select medical device or technology</option>';
            
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = `${device.name} - $${device.price_usd?.toLocaleString() || '0'} (${device.manufacturer})`;
                option.dataset.device = JSON.stringify(device);
                select.appendChild(option);
            });
            
            // Add change listener
            select.onchange = function() {
                const selectedOption = this.options[this.selectedIndex];
                const detailsDiv = document.getElementById('deviceDetails');
                if (!detailsDiv) return;
                
                if (selectedOption.value) {
                    try {
                        const device = JSON.parse(selectedOption.dataset.device);
                        detailsDiv.innerHTML = `
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <div class="text-xs"><span class="font-medium">Type:</span> ${escapeHtml(device.device_type)}</div>
                                <div class="text-xs mt-1"><span class="font-medium">TMDA Certified:</span> ${device.tz_certified ? '✅ Yes' : '⏳ Pending'}</div>
                                <div class="text-xs mt-1"><span class="font-medium">Local Support:</span> ${device.local_support ? '✅ Available' : '❌ Not Available'}</div>
                            </div>
                        `;
                    } catch (error) {
                        detailsDiv.innerHTML = '';
                    }
                } else {
                    detailsDiv.innerHTML = '';
                }
            };
        }

        function updateProviderSelect(providers) {
            const select = document.getElementById('providerSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select your hospital or clinic</option>';
            
            providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.id;
                option.textContent = `${provider.name} - ${provider.location}, ${provider.region}`;
                select.appendChild(option);
            });
        }

        function updateRegionFilters(providers) {
            const select = document.getElementById('regionFilter');
            if (!select) return;
            
            const regions = [...new Set(providers.map(p => p.region).filter(Boolean))].sort();
            
            select.innerHTML = '<option value="all">All Regions</option>';
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                select.appendChild(option);
            });
        }

        function updateFacilityFilters(providers) {
            const select = document.getElementById('facilityFilter');
            if (!select) return;
            
            const types = [...new Set(providers.map(p => p.facility_type).filter(Boolean))].sort();
            
            select.innerHTML = '<option value="all">All Types</option>';
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        }

        function loadFormData() {
            if (allDevices.length === 0) loadDevices();
            if (allProviders.length === 0) loadProviders();
        }

        function resetForm() {
            const form = document.getElementById('requestForm');
            const messageDiv = document.getElementById('requestMessage');
            const detailsDiv = document.getElementById('deviceDetails');
            
            if (form) form.reset();
            if (messageDiv) {
                messageDiv.classList.add('hidden');
                messageDiv.innerHTML = '';
            }
            if (detailsDiv) detailsDiv.innerHTML = '';
        }

        // ====== FILTER & SORT FUNCTIONS ======
        function filterDevices() {
            const filter = document.getElementById('deviceFilter').value;
            let filtered = [...allDevices];
            
            switch(filter) {
                case 'certified':
                    filtered = filtered.filter(d => d.tz_certified);
                    break;
                case 'local':
                    filtered = filtered.filter(d => d.local_support);
                    break;
            }
            
            displayDevices(filtered);
        }

        function sortDevices() {
            const sortBy = document.getElementById('deviceSort').value;
            let sorted = [...allDevices];
            
            switch(sortBy) {
                case 'name':
                    sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    break;
                case 'price-low':
                    sorted.sort((a, b) => (a.price_usd || 0) - (b.price_usd || 0));
                    break;
                case 'price-high':
                    sorted.sort((a, b) => (b.price_usd || 0) - (a.price_usd || 0));
                    break;
                case 'certified':
                    sorted.sort((a, b) => (b.tz_certified - a.tz_certified) || (a.name || '').localeCompare(b.name || ''));
                    break;
            }
            
            displayDevices(sorted);
        }

        function resetFilters() {
            const filterSelect = document.getElementById('deviceFilter');
            const sortSelect = document.getElementById('deviceSort');
            if (filterSelect) filterSelect.value = 'all';
            if (sortSelect) sortSelect.value = 'name';
            displayDevices(allDevices);
        }

        function filterProviders() {
            const region = document.getElementById('regionFilter').value;
            const type = document.getElementById('facilityFilter').value;
            
            let filtered = allProviders.filter(p => {
                const regionMatch = region === 'all' || p.region === region;
                const typeMatch = type === 'all' || p.facility_type === type;
                return regionMatch && typeMatch;
            });
            
            displayProviders(filtered);
        }

        function resetProviderFilters() {
            const regionFilter = document.getElementById('regionFilter');
            const facilityFilter = document.getElementById('facilityFilter');
            if (regionFilter) regionFilter.value = 'all';
            if (facilityFilter) facilityFilter.value = 'all';
            displayProviders(allProviders);
        }

        // ====== ANALYTICS FUNCTIONS ======
        function updateDashboardStats() {
            // Hero stats
            const heroDevices = document.getElementById('heroDevices');
            const heroProviders = document.getElementById('heroProviders');
            const heroCertified = document.getElementById('heroCertified');
            
            if (heroDevices) heroDevices.textContent = allDevices.length;
            if (heroProviders) heroProviders.textContent = allProviders.length;
            
            const certifiedCount = allDevices.filter(d => d.tz_certified).length;
            if (heroCertified) heroCertified.textContent = certifiedCount;
            
            // Dashboard stats
            const statDevices = document.getElementById('statDevices');
            const statProviders = document.getElementById('statProviders');
            const statCertified = document.getElementById('statCertified');
            const statLocalSupport = document.getElementById('statLocalSupport');
            
            if (statDevices) statDevices.textContent = allDevices.length;
            if (statProviders) statProviders.textContent = allProviders.length;
            if (statCertified) statCertified.textContent = certifiedCount;
            
            const localSupportCount = allDevices.filter(d => d.local_support).length;
            if (statLocalSupport) statLocalSupport.textContent = localSupportCount;
            
            // Analytics
            const analyticsDevices = document.getElementById('analyticsDevices');
            const analyticsProviders = document.getElementById('analyticsProviders');
            const analyticsCertified = document.getElementById('analyticsCertified');
            const analyticsRegions = document.getElementById('analyticsRegions');
            
            if (analyticsDevices) analyticsDevices.textContent = allDevices.length;
            if (analyticsProviders) analyticsProviders.textContent = allProviders.length;
            if (analyticsCertified) {
                analyticsCertified.textContent = allDevices.length > 0 ? 
                    `${Math.round((certifiedCount / allDevices.length) * 100)}%` : '0%';
            }
            
            const uniqueRegions = new Set(allProviders.map(p => p.region));
            if (analyticsRegions) analyticsRegions.textContent = uniqueRegions.size;
        }

        function updateRecentDevices(devices) {
            const container = document.getElementById('recentDevices');
            if (!container) return;
            
            if (!devices || devices.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center p-4 text-slate-400"><i class="fas fa-info-circle mr-2"></i>No recent devices</div>';
                return;
            }
            
            if (window.innerWidth <= 768) {
                let html = '';
                devices.forEach(device => {
                    html += `
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg mb-2">
                            <div>
                                <div class="font-medium text-sm">${escapeHtml(device.name)}</div>
                                <div class="text-xs text-slate-400">${escapeHtml(device.manufacturer)}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-[#0066cc] text-sm">$${device.price_usd?.toLocaleString() || '0'}</div>
                                ${device.tz_certified ? 
                                    '<span class="text-xs text-green-600">✓ Certified</span>' : 
                                    '<span class="text-xs text-yellow-600">⏳ Pending</span>'}
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } else {
                let html = '<table class="data-table"><thead><tr><th>Device</th><th>Manufacturer</th><th>Price</th><th>Status</th></tr></thead><tbody>';
                devices.forEach(device => {
                    html += `
                        <tr>
                            <td class="font-medium">${escapeHtml(device.name)}</td>
                            <td>${escapeHtml(device.manufacturer)}</td>
                            <td>$${device.price_usd?.toLocaleString() || '0'}</td>
                            <td>${device.tz_certified ? 
                                '<span class="px-2 py-1 bg-green-50 text-green-600 text-xs rounded-full">Certified</span>' : 
                                '<span class="px-2 py-1 bg-yellow-50 text-yellow-600 text-xs rounded-full">Pending</span>'}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            }
        }

        async function loadAnalytics() {
            updateDashboardStats();
            
            try {
                // Get regional distribution
                const regions = [...new Set(allProviders.map(p => p.region))];
                const regionData = regions.map(region => ({
                    region,
                    count: allProviders.filter(p => p.region === region).length
                }));
                
                updateRegionChart(regionData);
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateRegionChart(regions) {
            const container = document.getElementById('regionChart');
            if (!container) return;
            
            if (regions && regions.length > 0) {
                const total = regions.reduce((sum, r) => sum + r.count, 0);
                let html = '<div class="space-y-3 w-full">';
                
                regions.sort((a, b) => b.count - a.count).forEach(region => {
                    const percentage = total > 0 ? (region.count / total) * 100 : 0;
                    html += `
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-medium">${escapeHtml(region.region)}</span>
                                <span class="text-slate-500">${region.count} (${percentage.toFixed(1)}%)</span>
                            </div>
                            <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-[#0066cc] to-[#00b3b3] rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-sm text-slate-400">No regional data available</p>';
            }
        }

        function refreshAnalytics() {
            loadAnalytics();
            showToast('Analytics refreshed');
        }

        // ====== MODAL FUNCTIONS ======
        function showModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
                
                // Reset form if adding new
                if (type === 'device') {
                    const titleEl = document.getElementById('deviceModalTitle');
                    if (titleEl && titleEl.textContent === 'Add New Medical Device') {
                        const form = document.getElementById('deviceForm');
                        if (form) form.reset();
                        const deviceId = document.getElementById('deviceId');
                        if (deviceId) deviceId.value = '';
                    }
                }
                if (type === 'provider') {
                    const titleEl = document.getElementById('providerModalTitle');
                    if (titleEl && titleEl.textContent === 'Add New Healthcare Provider') {
                        const form = document.getElementById('providerForm');
                        if (form) form.reset();
                        const providerId = document.getElementById('providerId');
                        if (providerId) providerId.value = '';
                    }
                }
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
                
                if (type === 'delete') {
                    currentDeleteId = null;
                    currentDeleteType = null;
                }
            }
        }

        // ====== EXPORT FUNCTIONS ======
        function exportProviders() {
            const dataStr = JSON.stringify(allProviders, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `techmedixlink-providers-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Provider list exported successfully');
        }

        // ====== UTILITY FUNCTIONS ======
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function requestDevice(deviceId) {
            showSection('request');
            setTimeout(() => {
                const select = document.getElementById('deviceSelect');
                if (select) {
                    select.value = deviceId;
                    select.dispatchEvent(new Event('change'));
                }
            }, 100);
        }

        // Initialize stats
        updateRequestCount();

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.add('hidden');
                event.target.classList.remove('flex');
                document.body.style.overflow = '';
            }
        };

        // Handle window resize for responsive displays
        window.addEventListener('resize', function() {
            const devicesSection = document.getElementById('devices');
            const providersSection = document.getElementById('providers');
            
            if (devicesSection && !devicesSection.classList.contains('hidden')) {
                displayDevices(allDevices);
            }
            if (providersSection && !providersSection.classList.contains('hidden')) {
                displayProviders(allProviders);
            }
        });

        // Make functions globally available
        window.toggleMobileMenu = toggleMobileMenu;
        window.showSection = showSection;
        window.loadDevices = loadDevices;
        window.loadProviders = loadProviders;
        window.loadAllData = loadAllData;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.saveDevice = saveDevice;
        window.saveProvider = saveProvider;
        window.deleteDevice = deleteDevice;
        window.deleteProvider = deleteProvider;
        window.editDevice = editDevice;
        window.editProvider = editProvider;
        window.confirmDelete = confirmDelete;
        window.submitRequest = submitRequest;
        window.resetForm = resetForm;
        window.filterDevices = filterDevices;
        window.sortDevices = sortDevices;
        window.resetFilters = resetFilters;
        window.filterProviders = filterProviders;
        window.resetProviderFilters = resetProviderFilters;
        window.refreshAnalytics = refreshAnalytics;
        window.exportProviders = exportProviders;
        window.requestDevice = requestDevice;
    </script>
</body>
</html>
